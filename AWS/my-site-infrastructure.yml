AWSTemplateFormatVersion: 2010-09-09

Conditions:
  CreatePipelineBucket: !Equals [!Ref ExistingPipelineBucket, '']

  CreateDeployBucketAndPolicy: !Equals [!Ref ExistingDeployBucket, '']

  CreateDistributionLogsBucket:
    !Equals [!Ref ExistingDistributionLogsBucket, '']

  CreateLoadBalancerLogsBucketAndPolicy:
    !Equals [!Ref ExistingLoadBalancerLogsBucket, '']

Parameters:
  ExistingPipelineBucket:
    Type: String
    Default: arn:aws:s3:::my-site-pipeline-artifacts
  ExistingDeployBucket:
    Type: String
    Default: arn:aws:s3:::brendandagys.com
  ExistingDistributionLogsBucket:
    Type: String
    Default: arn:aws:s3:::my-site-cloudfront-distribution-logs
  ExistingLoadBalancerLogsBucket:
    Type: String
    Default: arn:aws:s3:::my-site-load-balancer-logs

  DeployBucketDomainName:
    Type: String
    Default: brendandagys.com.s3.amazonaws.com

  Repository:
    Type: String
    Default: my-site
  Branch:
    Type: String
    Default: main
    Description: e.g. main or master

  Certificate:
    Type: String
    Default: arn:aws:acm:us-east-1:708746137251:certificate/d61599f4-ca74-4bb7-893f-ed00e147d33c

  Domain:
    Type: String
    Default: brendandagys.com
  DomainWWW:
    Type: String
    Default: www.brendandagys.com

  HostedZoneId:
    Type: String
    Default: Z1048063LC3J2IKH5GGI

  ServiceName:
    Type: String
    Default: my-site-backend

  ImageURL:
    Type: String
    Default: 708746137251.dkr.ecr.us-east-1.amazonaws.com/my-site-backend
    Description: The URL of a Docker image that contains the application process that will handle the traffic for this service
  ImageURLFinances:
    Type: String
    Default: 708746137251.dkr.ecr.us-east-1.amazonaws.com/finances:latest
  ImageURLVocabularyTrainer:
    Type: String
    Default: 708746137251.dkr.ecr.us-east-1.amazonaws.com/vocabulary-trainer:latest

  ContainerName:
    Type: String
    Default: my-site-backend

  ContainerPort:
    Type: Number
    Default: 80
    Description: The port number that the application inside the Docker container is binding to
  ContainerPortFinances:
    Type: Number
    Default: 81
  ContainerPortVocabularyTrainer:
    Type: Number
    Default: 82
  ContainerCPU:
    Type: Number
    Default: 256
    Description: How many CPU to assign to the container (1024 = 1 CPU)
  ContainerMemory:
    Type: Number
    Default: 512
    Description: How many MB of memory to assign to the container
  DesiredCount:
    Type: Number
    Default: 1
    Description: The number of copies of the service task to run

  VpcCIDR:
    Type: String
    Default: 10.192.0.0/16
  PublicSubnet1CIDR:
    Type: String
    Default: 10.192.10.0/24
  PublicSubnet2CIDR:
    Type: String
    Default: 10.192.11.0/24
  # PrivateSubnet1CIDR:
  #   Type: String
  #   Default: 10.192.20.0/24

  VocabularyOrigin:
    Type: String
    Default: https://brendandagys.com

Resources:
  NetworkStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        EnvironmentName: !Sub '${AWS::StackName}'
        VpcCIDR: !Ref VpcCIDR
        PublicSubnet1CIDR: !Ref PublicSubnet1CIDR
        PublicSubnet2CIDR: !Ref PublicSubnet2CIDR
        # PrivateSubnet1CIDR: !Ref PrivateSubnet1CIDR
      TemplateURL: https://my-site-cloudformation-templates.s3.amazonaws.com/vpc-infrastructure.yml
      # TimeoutInMinutes: Integer

  CodePipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      ArtifactStore:
        Location: !Sub '${AWS::StackName}-pipeline-artifacts'
        Type: S3
      RoleArn: !GetAtt CodePipelineRole.Arn
      Stages:
        - Name: Source
          Actions:
            - Name: SourceAction
              ActionTypeId:
                Category: Source
                Owner: AWS
                Provider: CodeCommit
                Version: 1
              OutputArtifacts:
                - Name: !Sub '${AWS::StackName}-code'
              Configuration:
                RepositoryName: !Ref Repository
                BranchName: !Ref Branch
              RunOrder: 1

        - Name: Approval
          Actions:
            - Name: ApprovalAction
              ActionTypeId:
                Category: Approval
                Owner: AWS
                Provider: Manual
                Version: 1
              RunOrder: 2

        - Name: Build
          Actions:
            - Name: BuildAction
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: 1
              InputArtifacts:
                - Name: !Sub '${AWS::StackName}-code'
              OutputArtifacts:
                - Name: !Sub '${AWS::StackName}-build'
              Configuration:
                ProjectName: !Ref CodeBuild
              RunOrder: 3

  CodePipelineRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - codepipeline.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: root
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - codecommit:UploadArchive
                  - codecommit:GetCommit
                  - codecommit:GetUploadArchiveStatus
                  - codecommit:GetBranch
                  - codecommit:CancelUploadArchive
                Resource: '*'
              - Effect: Allow
                Action:
                  - codebuild:BatchGetBuilds
                  - codebuild:StartBuild
                Resource: '*'
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:GetBucketVersioning
                  - s3:PutObject
                Resource:
                  - '*'
                  # - !If [
                  #     CreatePipelineBucket,
                  #     !GetAtt PipelineBucket.Arn,
                  #     !Ref ExistingPipelineBucket,
                  #   ]
                  # - !Join [
                  #     '',
                  #     [
                  #       !If [
                  #         CreatePipelineBucket,
                  #         !GetAtt PipelineBucket.Arn,
                  #         !Ref ExistingPipelineBucket,
                  #       ],
                  #       '/*',
                  #     ],
                  #   ]

  CodeBuild:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub ${AWS::StackName}-CodeBuild
      ServiceRole: !GetAtt CodeBuildRole.Arn
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Type: LINUX_CONTAINER
        Image: aws/codebuild/standard:4.0
      Source:
        Type: CODEPIPELINE
        BuildSpec: !Sub |
          version: 0.2
          env:
            variables:
              INLINE_RUNTIME_CHUNK: "false"
          phases:
            install:
              commands:
                - cd frontend
                - npm install
            build:
              commands:
                - npm run build
                # - npm test
                # - echo $CODEBUILD_SRC_DIR
                - ls
            post_build:
              on-failure: ABORT #CONTINUE
              commands:
                - aws s3 cp --recursive --acl public-read ./build s3://${Domain}/
                
                - aws s3 cp --acl public-read --cache-control="max-age=0, no-cache, no-store, must-revalidate" ./build/index.html s3://${Domain}/
                
                - aws cloudfront create-invalidation --distribution-id ${Distribution} --paths "/*"
                
          artifacts:
            files:
              - 'frontend/build/**/*'

  CodeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - codebuild.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /service-role/
      Policies:
        - PolicyName: root
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:GetBucketVersioning
                  - s3:PutObject
                Resource:
                  - !If [
                      CreatePipelineBucket,
                      # !Ref PipelineBucket,
                      !GetAtt PipelineBucket.Arn,
                      !Ref ExistingPipelineBucket,
                    ]
                  - !Join [
                      '',
                      [
                        !If [
                          CreatePipelineBucket,
                          # !Ref PipelineBucket,
                          !GetAtt PipelineBucket.Arn,
                          !Ref ExistingPipelineBucket,
                        ],
                        '/*',
                      ],
                    ]
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:GetBucketVersioning
                  - s3:PutObject
                  - s3:PutObjectAcl
                Resource:
                  - 'arn:aws:s3:::*'
                  # - !Ref DeployBucket
                  # - !Join ['', [!Ref DeployBucket, '/*']]
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - cloudfront:CreateInvalidation
                Resource:
                  - '*'

  PipelineBucket:
    Type: AWS::S3::Bucket
    Condition: CreatePipelineBucket
    DeletionPolicy: Retain
    Properties:
      BucketName: !Sub '${AWS::StackName}-pipeline-artifacts'
      AccessControl: Private
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: true
        IgnorePublicAcls: false
        RestrictPublicBuckets: true

  DeployBucket:
    Type: AWS::S3::Bucket
    Condition: CreateDeployBucketAndPolicy
    DeletionPolicy: Retain
    Properties:
      BucketName: !Ref Domain
      AccessControl: Private
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: true
        IgnorePublicAcls: false
        RestrictPublicBuckets: true

  DeployBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Condition: CreateDeployBucketAndPolicy
    DeletionPolicy: Retain
    Properties:
      Bucket:
        !If [
          CreateDeployBucketAndPolicy,
          !Ref DeployBucket,
          !Ref ExistingDeployBucket,
        ]
      PolicyDocument:
        Id: MySiteDeployBucketPolicy
        Version: 2012-10-17
        Statement:
          - Sid: PolicyForCloudFrontPrivateContent
            Effect: Allow
            Principal:
              CanonicalUser: !GetAtt OriginAccessIdentity.S3CanonicalUserId
            Action: 's3:GetObject'
            Resource: !Join
              - ''
              - - 'arn:aws:s3:::'
                - !If [
                    CreateDeployBucketAndPolicy,
                    !Ref DeployBucket,
                    !Ref ExistingDeployBucket,
                  ]
                - /*

  DistributionLogsBucket:
    Type: AWS::S3::Bucket
    Condition: CreateDistributionLogsBucket
    DeletionPolicy: Retain
    Properties:
      BucketName: !Sub '${AWS::StackName}-cloudfront-distribution-logs'
      AccessControl: LogDeliveryWrite
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: ExpireLogs
            ExpirationInDays: 365
            Status: Enabled

  LoadBalancerLogsBucket:
    Type: AWS::S3::Bucket
    Condition: CreateLoadBalancerLogsBucketAndPolicy
    DeletionPolicy: Retain
    Properties:
      BucketName: !Sub '${AWS::StackName}-load-balancer-logs'
      AccessControl: LogDeliveryWrite
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: ExpireLogs
            ExpirationInDays: 365
            Status: Enabled

  LoadBalancerLogsBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Condition: CreateLoadBalancerLogsBucketAndPolicy
    DeletionPolicy: Retain
    Properties:
      Bucket:
        !If [
          CreateLoadBalancerLogsBucketAndPolicy,
          !Ref LoadBalancerLogsBucket,
          !Ref ExistingLoadBalancerLogsBucket,
        ]
      PolicyDocument:
        Id: MySiteLoadBalancerLogsBucketPolicy
        Version: 2012-10-17
        Statement:
          - Sid: PolicyForWriteOfLoadBalancerLogs
            Effect: Allow
            Principal:
              AWS: 127311923021 # us-east-1
            Action: s3:PutObject
            Resource: !Join
              - ''
              - - 'arn:aws:s3:::'
                - !If [
                    CreateLoadBalancerLogsBucketAndPolicy,
                    !Ref LoadBalancerLogsBucket,
                    !Ref ExistingLoadBalancerLogsBucket,
                  ]
                - /*

  Distribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        Comment: !Sub 'Origin 1: S3 SPA for ${AWS::StackName} | Origin 2: API Fargate container for ${AWS::StackName}'
        Aliases:
          - !Ref Domain
          - !Ref DomainWWW
        Origins:
          - Id:
              !If [
                CreateDeployBucketAndPolicy,
                !Ref DeployBucket,
                !Ref ExistingDeployBucket,
              ]
            DomainName: !Ref DeployBucketDomainName
            S3OriginConfig:
              OriginAccessIdentity:
                !Join [
                  '',
                  [
                    'origin-access-identity/cloudfront/',
                    !Ref OriginAccessIdentity,
                  ],
                ]
          - Id: !Ref FargateService
            DomainName: !GetAtt FargateServiceLoadBalancer.DNSName
            CustomOriginConfig:
              OriginProtocolPolicy: https-only
              OriginSSLProtocols:
                - TLSv1.2
        ViewerCertificate:
          AcmCertificateArn: !Ref Certificate
          SslSupportMethod: sni-only
          MinimumProtocolVersion: TLSv1.2_2021
        CustomErrorResponses:
          - ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html
            ErrorCachingMinTTL: 10
          - ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /index.html
            ErrorCachingMinTTL: 10
        DefaultRootObject: index.html
        PriceClass: PriceClass_100
        HttpVersion: http2
        IPV6Enabled: false
        DefaultCacheBehavior:
          TargetOriginId:
            !If [
              CreateDeployBucketAndPolicy,
              !Ref DeployBucket,
              !Ref ExistingDeployBucket,
            ]
          ViewerProtocolPolicy: redirect-to-https
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6
          Compress: true
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          CachedMethods:
            - GET
            - HEAD
          FunctionAssociations:
            - EventType: viewer-request
              FunctionARN: !Ref CloudFrontFunctionCanonicalURL
            - EventType: viewer-response
              FunctionARN: !Ref CloudFrontFunctionSecurityHeaders
        CacheBehaviors:
          - PathPattern: api/*
            TargetOriginId: !Ref FargateService
            ViewerProtocolPolicy: redirect-to-https
            CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad
            OriginRequestPolicyId: 216adef6-5c7f-47e4-b989-5492eafa07d3
            Compress: true
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
              - POST
              - PUT
              - PATCH
              - DELETE
            CachedMethods:
              - GET
              - HEAD
            FunctionAssociations: # API DOES NOT NEED WWW.-REDIRECTION
              - EventType: viewer-response
                FunctionARN: !Ref CloudFrontFunctionSecurityHeaders
        Logging:
          Bucket: !Sub '${AWS::StackName}-cloudfront-distribution-logs.s3.amazonaws.com'
          IncludeCookies: true
          Prefix: !Sub '${AWS::StackName}-logs'

  CloudFrontFunctionSecurityHeaders:
    Type: AWS::CloudFront::Function
    Properties:
      Name: !Sub '${AWS::StackName}-viewer-response'
      FunctionConfig:
        Comment: Adds HTTP security headers to the viewer response
        Runtime: cloudfront-js-1.0
      AutoPublish: true
      FunctionCode: |
        function handler(event) {
            var response = event.response;
            var headers = response.headers;

            // Set HTTP security headers
            // Since JavaScript doesn't allow for hyphens in variable names, we use the dict["key"] notation
            
            headers['strict-transport-security'] = { value: 'max-age=63072000; includeSubdomains; preload'};
            
            headers['content-security-policy'] = { value: "default-src 'none'; img-src 'self' data:; script-src 'self'; object-src 'none'; connect-src 'self' https://vocabulary.brendandagys.com; manifest-src 'self'; style-src https://*.brendandagys.com *.cloudflare.com 'unsafe-inline'; style-src-elem 'self' https://cdnjs.cloudflare.com https://fonts.googleapis.com 'unsafe-inline'; font-src https://fonts.gstatic.com https://*.cloudflare.com"};
            
            headers['x-content-type-options'] = { value: 'nosniff'};
            headers['x-frame-options'] = {value: 'DENY'};
            headers['x-xss-protection'] = {value: '1; mode=block'};

            delete headers['x-powered-by'];

            // Return the response to viewers 
            return response;
        }

  CloudFrontFunctionCanonicalURL:
    Type: AWS::CloudFront::Function
    Properties:
      Name: !Sub '${AWS::StackName}-viewer-request'
      FunctionConfig:
        Comment: Converts WWW. URLs to canonical URL
        Runtime: cloudfront-js-1.0
      AutoPublish: true
      FunctionCode: |
        function handler(event) {
            var request = event.request;
            var host = request.headers.host.value;
            var uri = request.uri; // Is the path after `.com`
            
            if (host.includes('www.')) {
                var response = {
                    statusCode: 302,
                    statusDescription: 'Found',
                    headers: {'location': { value: `https://${host.replace('www.', '')}${uri}` }}
                };
            return response;
            }
            return request;
        }

  OriginAccessIdentity:
    Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: !Sub
          - '${Domain} OAI'
          - { Domain: !Ref Domain }

  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Sub '${AWS::StackName}'

  FargateService:
    Type: AWS::ECS::Service
    DependsOn:
      - ListenerHTTPS
      - ListenerHTTPSRuleFinances
      - ListenerHTTPSRuleVocabularyTrainer
      - MySiteTargetGroup
      - FinancesTargetGroup
      - VocabularyTrainerTargetGroup
    Properties:
      ServiceName: !Ref ServiceName
      Cluster: !Ref ECSCluster
      TaskDefinition: !Ref FargateServiceTaskDefinition
      LaunchType: FARGATE
      DesiredCount: !Ref DesiredCount
      LoadBalancers:
        - ContainerName: !Ref ContainerName
          ContainerPort: !Ref ContainerPort
          TargetGroupArn: !Ref MySiteTargetGroup
        - ContainerName: finances
          ContainerPort: !Ref ContainerPortFinances
          TargetGroupArn: !Ref FinancesTargetGroup
        - ContainerName: vocabulary-trainer
          ContainerPort: !Ref ContainerPortVocabularyTrainer
          TargetGroupArn: !Ref VocabularyTrainerTargetGroup
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          Subnets:
            - !GetAtt NetworkStack.Outputs.PublicSubnet1
          SecurityGroups:
            - !Ref ContainerSecurityGroup
      EnableECSManagedTags: true

  FargateServiceTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Ref ServiceName
      NetworkMode: awsvpc
      Cpu: !Ref ContainerCPU
      Memory: !Ref ContainerMemory
      ExecutionRoleArn: 'arn:aws:iam::708746137251:role/ecs-task-execution-role'
      ContainerDefinitions:
        - Image: !Ref ImageURL
          Name: !Ref ContainerName
          PortMappings:
            - Protocol: tcp
              ContainerPort: !Ref ContainerPort
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-region: !Ref AWS::Region
              awslogs-group: !Ref FargateTaskDefinitionLogGroup
              awslogs-stream-prefix: !Sub 'ecs/${AWS::StackName}'
          Environment:
            - Name: NODE_ENV
              Value: production
        - Image: !Ref ImageURLFinances
          Name: finances
          PortMappings:
            - Protocol: tcp
              ContainerPort: !Ref ContainerPortFinances
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-region: !Ref AWS::Region
              awslogs-group: !Ref FargateTaskDefinitionLogGroup
              awslogs-stream-prefix: ecs/finances
          Environment:
            - Name: NODE_ENV
              Value: production
            - Name: PORT
              Value: !Ref ContainerPortFinances
            - Name: MONGO_URI_PROD
              Value: '{{resolve:secretsmanager:finances:SecretString:MONGO_URI_PROD}}'
            - Name: GOOGLE_CLIENT_ID_PROD
              Value: '{{resolve:secretsmanager:finances:SecretString:GOOGLE_CLIENT_ID_PROD}}'
            - Name: GOOGLE_CLIENT_SECRET_PROD
              Value: '{{resolve:secretsmanager:finances:SecretString:GOOGLE_CLIENT_SECRET_PROD}}'
            - Name: COOKIE_KEY
              Value: '{{resolve:secretsmanager:finances:SecretString:COOKIE_KEY}}'
            - Name: AWS_ACCESS_KEY_ID
              Value: '{{resolve:secretsmanager:finances:SecretString:AWS_ACCESS_KEY_ID}}'
            - Name: AWS_SECRET_ACCESS_KEY
              Value: '{{resolve:secretsmanager:finances:SecretString:AWS_SECRET_ACCESS_KEY}}'
            - Name: AWS_BUCKET_NAME
              Value: '{{resolve:secretsmanager:finances:SecretString:AWS_BUCKET_NAME}}'
        - Image: !Ref ImageURLVocabularyTrainer
          Name: vocabulary-trainer
          PortMappings:
            - Protocol: tcp
              ContainerPort: !Ref ContainerPortVocabularyTrainer
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-region: !Ref AWS::Region
              awslogs-group: !Ref FargateTaskDefinitionLogGroup
              awslogs-stream-prefix: ecs/vocabulary-trainer
          Environment:
            - Name: ORIGIN
              Value: !Ref VocabularyOrigin
            - Name: PORT
              Value: !Ref ContainerPortVocabularyTrainer

  FargateTaskDefinitionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub
        - '/ecs/${ServiceName}-task-definition'
        - { ServiceName: !Ref ServiceName }

  ContainerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub '${AWS::StackName} containers Security Group'
      VpcId: !GetAtt NetworkStack.Outputs.VPC
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 0
          ToPort: 65535
          CidrIp: 0.0.0.0/0

  ContainerSecurityGroupInboundRule:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      IpProtocol: tcp
      FromPort: 80
      ToPort: 83
      SourceSecurityGroupId: !GetAtt FargateServiceLoadBalancerSecurityGroup.GroupId
      GroupId: !GetAtt ContainerSecurityGroup.GroupId

  FargateServiceLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub
        - '${ServiceName}-ALB'
        - { ServiceName: !Ref ServiceName }
      Scheme: internet-facing
      Type: application
      Subnets:
        - !GetAtt NetworkStack.Outputs.PublicSubnet1
        - !GetAtt NetworkStack.Outputs.PublicSubnet2
      SecurityGroups:
        - !Ref FargateServiceLoadBalancerSecurityGroup
      IpAddressType: ipv4
      LoadBalancerAttributes:
        - Key: access_logs.s3.enabled
          Value: true
        - Key: access_logs.s3.bucket
          Value: !Sub '${AWS::StackName}-load-balancer-logs'

  FargateServiceLoadBalancerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Fargate Service ALB Security Group
      VpcId: !GetAtt NetworkStack.Outputs.VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0

  FargateServiceLoadBalancerSecurityGroupOutboundRule:
    Type: AWS::EC2::SecurityGroupEgress
    Properties:
      IpProtocol: tcp
      FromPort: 80
      ToPort: 83
      DestinationSecurityGroupId: !GetAtt ContainerSecurityGroup.GroupId
      GroupId: !GetAtt FargateServiceLoadBalancerSecurityGroup.GroupId

  MySiteTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub '${AWS::StackName}-target-group'
      Protocol: HTTP
      Port: !Ref ContainerPort
      TargetType: ip
      VpcId: !GetAtt NetworkStack.Outputs.VPC
      HealthCheckEnabled: true
      HealthCheckPath: /api/health

  FinancesTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    DependsOn:
      - FargateServiceLoadBalancer
    Properties:
      Name: finances-target-group
      Protocol: HTTP
      Port: !Ref ContainerPortFinances
      TargetType: ip
      VpcId: !GetAtt NetworkStack.Outputs.VPC
      HealthCheckEnabled: true
      HealthCheckPath: /api/finances/health

  VocabularyTrainerTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    DependsOn:
      - FargateServiceLoadBalancer
    Properties:
      Name: vocabulary-trainer-target-group
      Protocol: HTTP
      Port: !Ref ContainerPortVocabularyTrainer
      TargetType: ip
      VpcId: !GetAtt NetworkStack.Outputs.VPC
      HealthCheckEnabled: true
      HealthCheckPath: /api/health

  ListenerHTTPS:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref FargateServiceLoadBalancer
      Protocol: HTTPS
      Port: 443
      SslPolicy: ELBSecurityPolicy-2016-08
      Certificates:
        - CertificateArn: !Ref Certificate
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref MySiteTargetGroup

  ListenerHTTPSRuleFinances:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      Priority: 2
      ListenerArn: !Ref ListenerHTTPS
      Conditions:
        - Field: host-header
          HostHeaderConfig:
            Values:
              - finances.brendandagys.com
      Actions:
        - Type: forward
          TargetGroupArn: !Ref FinancesTargetGroup
          ForwardConfig:
            TargetGroups:
              - TargetGroupArn: !Ref FinancesTargetGroup
                Weight: 1
          # Order: 1

  ListenerHTTPSRuleVocabularyTrainer:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      Priority: 1
      ListenerArn: !Ref ListenerHTTPS
      Conditions:
        - Field: host-header
          HostHeaderConfig:
            Values:
              - vocabulary.brendandagys.com
        # - Field: path-pattern
        #   PathPatternConfig:
        #     Values:
        #       - '/api/vocabulary-trainer/*'
      Actions:
        - Type: forward
          TargetGroupArn: !Ref VocabularyTrainerTargetGroup
          ForwardConfig:
            TargetGroups:
              - TargetGroupArn: !Ref VocabularyTrainerTargetGroup
                Weight: 1

  # ListenerHTTP:
  #   Type: AWS::ElasticLoadBalancingV2::Listener
  #   Properties:
  #     LoadBalancerArn: !Ref FargateServiceLoadBalancer
  #     Protocol: HTTP
  #     Port: 80
  #     DefaultActions:
  #       - Type: redirect
  #         RedirectConfig:
  #           Protocol: HTTPS
  #           Port: 443
  #           Host: '#{host}'
  #           Path: '/#{path}'
  #           Query: '#{query}'
  #           StatusCode: 'HTTP_301'

  DNSRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Ref Domain
      Type: A
      AliasTarget:
        HostedZoneId: Z2FDTNDATAQYW2
        DNSName: !GetAtt Distribution.DomainName

  DNSRecordWWW:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Ref DomainWWW
      Type: A
      AliasTarget:
        HostedZoneId: Z2FDTNDATAQYW2
        DNSName: !GetAtt Distribution.DomainName

Outputs:
  CodePipelineRole:
    Value: !GetAtt CodePipelineRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-CodePipeline-role'

  CodeBuildRole:
    Value: !GetAtt CodeBuildRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-CodeBuild-role'

  FargateService:
    Value: !Ref FargateService
    Export:
      Name: !Sub '${AWS::StackName}-Fargate-service'

  FargateServiceLoadBalancer:
    Value: !GetAtt FargateServiceLoadBalancer.DNSName
    Export:
      Name: !Sub '${AWS::StackName}-Fargate-service-load-balancer-DNS-name'

  Certificate:
    Value: !Ref Certificate
    Export:
      Name: !Sub '${AWS::StackName}-certificate'

  CloudFrontFunctionSecurityHeaders:
    Value: !Ref CloudFrontFunctionSecurityHeaders
    Export:
      Name: !Sub '${AWS::StackName}-CloudFront-function-security-headers'

  CloudFrontFunctionCanonicalURL:
    Value: !Ref CloudFrontFunctionCanonicalURL
    Export:
      Name: !Sub '${AWS::StackName}-CloudFront-function-canonical-URL'

  FargateServiceLoadBalancerArn:
    Description: Used by Django template
    Value: !Ref FargateServiceLoadBalancer
    Export:
      Name: !Sub '${AWS::StackName}-fargate-service-load-balancer-arn'

  FargateServiceLoadBalancerHostedZoneId:
    Value: !GetAtt FargateServiceLoadBalancer.CanonicalHostedZoneID
    Export:
      Name: !Sub '${AWS::StackName}-fargate-service-load-balancer-hosted-zone-id'

  FargateClusterName:
    Description: Used by Django template
    Value: !Ref ECSCluster
    Export:
      Name: !Sub '${AWS::StackName}-fargate-cluster'
